@model IEnumerable<DesapegAutoWeb.Models.AnuncioViewModel>
@using System.Globalization
@{
    ViewData["Title"] = "Pesquisa";
    var anuncios = Model?.ToList() ?? new List<DesapegAutoWeb.Models.AnuncioViewModel>();
    var opcionaisSelecionados = (ViewBag.Opcionais as IEnumerable<string> ?? Enumerable.Empty<string>()).ToHashSet(StringComparer.OrdinalIgnoreCase);

    bool IsSelected(string value) => opcionaisSelecionados.Contains(value);
}

<div class="da-page">
    <div class="da-search-layout">
        <aside class="da-filter-panel">
            <div class="da-top-actions">
                <h2 class="da-filter-title" style="margin:0;">Filtros</h2>
                <a asp-controller="Home" asp-action="Index" class="da-btn da-btn-soft" aria-label="Voltar">←</a>
            </div>

            <form asp-controller="Home" asp-action="Search" method="get" class="da-stack">
                <button type="submit" class="da-btn da-btn-outline da-btn-wide">Limpar filtros</button>

                <div class="da-field">
                    <p class="da-label">Localização</p>
                    <input type="text" name="localizacao" class="da-input" value="@ViewBag.Localizacao" placeholder="Digite sua cidade ou estado" />
                </div>

                <div class="da-field">
                    <p class="da-label">Preço</p>
                    <p class="da-muted">Escolha um intervalo</p>
                    <div class="da-inline-range">
                        <input type="number" name="precoMin" class="da-input" value="@ViewBag.PrecoMin" placeholder="Mínimo" />
                        <input type="number" name="precoMax" class="da-input" value="@ViewBag.PrecoMax" placeholder="Máximo" />
                    </div>
                </div>

                <div class="da-field">
                    <p class="da-label">Ano</p>
                    <p class="da-muted">Escolha um intervalo</p>
                    <div class="da-inline-range">
                        <input type="number" name="anoMin" class="da-input" value="@ViewBag.AnoMin" placeholder="De" />
                        <input type="number" name="anoMax" class="da-input" value="@ViewBag.AnoMax" placeholder="Até" />
                    </div>
                </div>

                <div class="da-field">
                    <p class="da-label">Quilometragem</p>
                    <p class="da-muted">Escolha um intervalo</p>
                    <div class="da-inline-range">
                        <input type="number" name="kmMin" class="da-input" value="@ViewBag.KmMin" placeholder="Mínimo" />
                        <input type="number" name="kmMax" class="da-input" value="@ViewBag.KmMax" placeholder="Máximo" />
                    </div>
                </div>

                <div class="da-field">
                    <p class="da-label">Opcionais</p>
                    <div class="da-checkbox-grid">
                        <label class="da-check-item"><input type="checkbox" name="opcionais" value="ar condicionado" @(IsSelected("ar condicionado") ? "checked" : "") />Ar condicionado</label>
                        <label class="da-check-item"><input type="checkbox" name="opcionais" value="direção hidráulica" @(IsSelected("direção hidráulica") ? "checked" : "") />Direção hidráulica</label>
                        <label class="da-check-item"><input type="checkbox" name="opcionais" value="vidros elétricos" @(IsSelected("vidros elétricos") ? "checked" : "") />Vidros elétricos</label>
                        <label class="da-check-item"><input type="checkbox" name="opcionais" value="airbag" @(IsSelected("airbag") ? "checked" : "") />Airbag</label>
                        <label class="da-check-item"><input type="checkbox" name="opcionais" value="alarme" @(IsSelected("alarme") ? "checked" : "") />Alarme</label>
                        <label class="da-check-item"><input type="checkbox" name="opcionais" value="som" @(IsSelected("som") ? "checked" : "") />Som</label>
                    </div>
                </div>

                <input type="hidden" name="termo" value="@ViewBag.Termo" />
                <button type="submit" class="da-btn da-btn-primary da-btn-wide">Aplicar filtros</button>
            </form>
        </aside>

        <section class="da-results-panel">
            <h2 class="da-subtitle">Resultados da pesquisa</h2>

            @if (anuncios.Any())
            {
                foreach (var anuncio in anuncios)
                {
                    var nomeVeiculo = $"{anuncio.Veiculo?.NomeMarca} {anuncio.Veiculo?.NomeModelo}".Trim();
                    if (string.IsNullOrWhiteSpace(nomeVeiculo))
                    {
                        nomeVeiculo = "Veículo";
                    }

                    <article class="da-result-card">
                        <div class="da-result-image">
                            <div class="da-vehicle-placeholder">Imagem do veículo</div>
                        </div>
                        <div class="da-result-body">
                            <h3 class="da-vehicle-name">@nomeVeiculo</h3>
                            <p class="da-vehicle-year">@anuncio.Veiculo?.Ano</p>
                            <p class="da-vehicle-price">@((anuncio.Veiculo?.Preco ?? 0m).ToString("C0", new CultureInfo("pt-BR")))</p>
                            <a asp-controller="Anuncio" asp-action="Details" asp-route-id="@anuncio.Id" class="da-btn da-btn-outline da-btn-wide">Ver detalhes</a>
                        </div>
                    </article>
                }
            }
            else
            {
                <div class="da-empty">Nenhum veículo encontrado com os filtros selecionados.</div>
            }
        </section>
    </div>
</div>
